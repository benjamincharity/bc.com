---
import BaseLayout from '~/layouts/BaseLayout.astro';
import { getCollection, getEntry } from 'astro:content';
import { processMarkdown } from '~/utils/markdown-processor';
import NewsletterForm from '~/components/islands/NewsletterForm';

export async function getStaticPaths() {
  const articles = await getCollection('blog');
  return articles
    .filter(article => !article.data.draft && article.id)
    .map((article) => ({
      params: { slug: article.id },
    }));
}

const { slug } = Astro.params;
const entry = await getEntry('blog', slug);

if (!entry) {
  throw new Error(`Article not found: ${slug}`);
}

const article = entry.data;
const body = entry.body || '';

// Process markdown with our custom processor that includes Cloudinary transformation
const htmlContent = await processMarkdown(body);

const siteMetadata = {
  title: 'Benjamin Charity',
  description: 'Building products & Engineering teams',
};
---

<BaseLayout
  title={`${article.title} | Benjamin Charity`}
  description={article.description || `Article: ${article.title}`}
  showBackground={false}
>
  <div class="prose-wrapper">
    <main>
      <header class="mb-8">
        <nav class="mb-6">
          <a
            href="/articles"
            class="text-blue-500 dark:text-blue-300 hover:underline font-vt323"
          >
&larr; Back to Articles
          </a>
        </nav>

        <h1 class="font-vt323 text-title text-gray-800 dark:text-white mb-4">
          {article.title}
        </h1>

        <div class="text-sm text-gray-500 dark:text-gray-400 mb-4">
          Published on {new Date(article.date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </div>

        {article.tags && article.tags.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-6">
            {article.tags.map((tag: string) => (
              <span class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded text-sm">
                {tag}
              </span>
            ))}
          </div>
        )}
      </header>

      <article class="rendered-markdown" set:html={htmlContent}></article>

      <!-- Newsletter Signup Section -->
      <section class="max-w-screen-2xl mx-auto px-8 py-12 mt-12">
        <hr class="fancy mb-12" />
        <div class="max-w-xl mx-auto text-center">
          <h2 class="mb-1 text-2xl font-semibold font-sourceSerif4 text-gray-800 dark:text-white">
            Build, Scale, Succeed
          </h2>
          <p class="mb-6 leading-tight text-gray-600 dark:text-gray-300">
            Join others receiving expert advice on<br /> engineering and product development.
          </p>
          <NewsletterForm
            className="mx-auto"
            successMessage="Boom! You're in the club! ðŸŽ‰ Expect a warm welcome in your inbox soon!"
            client:load
          />
        </div>
        <hr class="fancy mt-12" />
      </section>

      <footer class="text-center pt-8 mt-12 border-t border-gray-200 dark:border-gray-700">
        <a
          href="/articles"
          class="text-blue-500 dark:text-blue-300 hover:underline font-vt323 text-lg"
        >
&larr; Back to Articles
        </a>
      </footer>
    </main>
  </div>
</BaseLayout>