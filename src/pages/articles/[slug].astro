---
export const prerender = false; // Enable server-side rendering for draft param support

import BaseLayout from '~/layouts/BaseLayout.astro';
import { getCollection, getEntry } from 'astro:content';
import { processMarkdown } from '~/utils/markdown-processor';
import NewsletterForm from '~/components/islands/NewsletterForm';
import BrowseByTags from '~/components/islands/BrowseByTags';

const { slug } = Astro.params;
const entry = await getEntry('blog', slug);

if (!entry) {
  throw new Error(`Article not found: ${slug}`);
}

// Check for draft query param
const url = new URL(Astro.request.url);
const showDrafts = url.searchParams.get('draft') === 'true';

// If article is a draft and we're not showing drafts, return 404
if (entry.data.draft && !showDrafts) {
  return Astro.redirect('/404');
}

const article = entry.data;
const body = entry.body || '';

// Process markdown with our custom processor that includes Cloudinary transformation
const htmlContent = await processMarkdown(body);

// Get all articles to calculate tag counts
const allArticles = await getCollection('blog');
const publishedArticles = allArticles.filter(a => !a.data.draft);

// Calculate tag counts
const tagCounts = new Map<string, number>();
publishedArticles.forEach(a => {
  const tags = a.data.tags || [];
  tags.forEach(tag => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});

// Filter to only show tags from this article
const articleTags = article.tags || [];
const tagsWithCounts = articleTags
  .map(tag => [tag, tagCounts.get(tag) || 0] as [string, number])
  .filter(([_, count]) => count > 0);

const siteMetadata = {
  title: 'Benjamin Charity',
  description: 'Building products & Engineering teams',
};
---

<BaseLayout
  title={`${article.title} | Benjamin Charity`}
  description={article.description || `Article: ${article.title}`}
  showBackground={false}
>
  <div class="prose-wrapper">
    <main>
      <nav class="mb-6 text-center">
        <a
          href="/articles"
          class="text-blue-500 dark:text-blue-300 hover:underline font-bold"
        >
â‡œ Back to all articles
        </a>
      </nav>

      <header class="mb-4">
        <div class="flex gap-x-2 leading-tight text-gray-600 dark:text-gray-400 mb-1">
          <div class="font-mono text-[10px] italic">
            Published: {new Date(article.date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </div>
        </div>

        <h1 class="my-1 font-sourceSerif4 text-3xl font-bold leading-tight text-gray-700 dark:text-gray-300">
          {article.title}
        </h1>

        <p class="reading-time text-gray-600 dark:text-gray-400 text-sm mb-4">
          Reading time: {article.readingTime || '5'}min
        </p>
      </header>

      <article class="rendered-markdown" set:html={htmlContent}></article>

      <!-- Newsletter Signup Section -->
      <section class="max-w-screen-2xl mx-auto px-8 py-12 mt-12">
        <hr class="fancy mb-12" />
        <div class="max-w-xl mx-auto text-center">
          <h2 class="mb-1 text-2xl font-semibold font-sourceSerif4 text-gray-800 dark:text-white">
            Build, Scale, Succeed
          </h2>
          <p class="mb-6 leading-tight text-gray-600 dark:text-gray-300">
            Join others receiving expert advice on<br /> engineering and product development.
          </p>
          <NewsletterForm
            className="mx-auto"
            successMessage="Boom! You're in the club! ðŸŽ‰ Expect a warm welcome in your inbox soon!"
            client:load
          />
        </div>
        <hr class="fancy mt-12" />
      </section>

      {tagsWithCounts.length > 0 && (
        <section class="mb-8">
          <BrowseByTags
            tags={tagsWithCounts}
            heading="Tags:"
            client:load
          />
        </section>
      )}

      <footer class="text-center pt-8 mt-12 border-t border-gray-200 dark:border-gray-700">
        <a
          href="/articles"
          class="text-blue-500 dark:text-blue-300 hover:underline font-vt323 text-lg"
        >
&larr; Back to Articles
        </a>
      </footer>
    </main>
  </div>
</BaseLayout>