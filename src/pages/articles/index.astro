---
export const prerender = true;

import BaseLayout from '~/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import ArticlesPageWrapper from '~/components/islands/ArticlesPageWrapper';
import NewsletterForm from '~/components/islands/NewsletterForm';
import BrowseByTags from '~/components/islands/BrowseByTags';
import { siteMetadata } from '~/data/siteMetadata';
import { generateArticlesIndexKeywords } from '~/utils/keyword-generator';

// Get all articles from the blog collection
const articles = await getCollection('blog');

// Filter drafts based on environment and sort by date (newest first)
// In development: show all articles including drafts
// In production: hide draft articles
const sortedArticles = articles
  .filter(article => import.meta.env.DEV || !article.data.draft)
  .sort((a, b) => {
    return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
  })
  .map(article => ({
    ...article,
    readingTime: article.data.readingTime || 5, // Default to 5 min if not set
  }));

// Get all tags and their counts for BrowseByTags component
const tagCounts = new Map<string, number>();
sortedArticles.forEach(article => {
  const tags = article.data.tags || [];
  tags.forEach(tag => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});
const tagsForBrowse = Array.from(tagCounts.entries());

// Breadcrumb schema for articles index
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: siteMetadata.url,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Articles',
      item: `${siteMetadata.url}/articles`,
    },
  ],
};
---

<BaseLayout
  title={`Articles on startups and engineering, by ${siteMetadata.author}`}
  description="Explore expert articles on engineering leadership in startups and scale-ups. Discover guides on career paths, team dynamics, and innovation in tech."
  showBackground={false}
  keywords={generateArticlesIndexKeywords()}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  </Fragment>
  <section class="prose-wrapper prose-wrapper--large">
    <ArticlesPageWrapper articles={sortedArticles} client:visible />

    <div class="max-w-screen-2xl mx-auto px-8 py-12">
      <div class="max-w-xl mx-auto text-center">
        <h2 class="mb-1 text-2xl font-semibold font-sourceSerif4 text-gray-800 dark:text-white">
          Build, Scale, Succeed
        </h2>
        <p class="mb-6 leading-tight text-gray-600 dark:text-gray-300">
          Join others receiving expert advice on<br /> engineering and product development.
        </p>
        <NewsletterForm
          className="mx-auto"
          successMessage="Boom! You're in the club! ðŸŽ‰ Expect a warm welcome in your inbox soon!"
          client:visible
        />
      </div>
    </div>

    <hr class="fancy" />

    <BrowseByTags
      tags={tagsForBrowse}
      heading="Browse by tags:"
      id="tags-section"
      client:idle
    />
  </section>
</BaseLayout>